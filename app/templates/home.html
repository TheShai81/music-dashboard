{% extends "base.html" %}

{% block content %}
<h2 class="mb-3">Your Spotify Dashboard</h2>
<p class="text-muted">
    This page shows your liked songs, your friends, and lets you run various queries
    on top of our Spotify database.
</p>

<hr>

<!-- 1. Query submission form -->
<h4>Request a dashboard query</h4>
<form method="POST" class="row g-2 mb-4">
    <div class="col-12">
        <div class="form-check">
            <input class="form-check-input" type="radio" name="desired_query" id="genresQuery" value="genres" checked>
            <label class="form-check-label" for="genresQuery">
                Top 3 most-liked <strong>genres</strong>
            </label>
        </div>

        <div class="form-check">
            <input class="form-check-input" type="radio" name="desired_query" id="artistsQuery" value="artists">
            <label class="form-check-label" for="artistsQuery">
                Top 3 most-liked <strong>artists</strong>
            </label>
        </div>

        <div class="form-check">
            <input class="form-check-input" type="radio" name="desired_query" id="discoveryQuery" value="discovery">
            <label class="form-check-label" for="discoveryQuery">
                Generate a <strong>discovery playlist</strong>
            </label>
        </div>

        <div class="form-check">
            <input class="form-check-input" type="radio" name="desired_query" id="soulmateQuery" value="soulmate">
            <label class="form-check-label" for="soulmateQuery">
                Find my musical <strong>soulmate</strong>
            </label>
        </div>

        <div class="form-check">
            <input class="form-check-input" type="radio" name="desired_query" id="compatQuery" value="compatibility">
            <label class="form-check-label" for="compatQuery">
                Compute <strong>compatibility</strong> with a friend
            </label>
        </div>

        <div class="form-check">
            <input class="form-check-input" type="radio" name="desired_query" id="recoFriendQuery" value="recommend_friend">
            <label class="form-check-label" for="recoFriendQuery">
                Recommend a <strong>friend of a friend</strong>
            </label>
        </div>

        <div class="form-check">
            <input class="form-check-input" type="radio" name="desired_query" id="dashboardQuery" value="dashboard">
            <label class="form-check-label" for="dashboardQuery">
                Generate my <strong>dashboard image</strong>
            </label>
        </div>

        <div class="form-check">
            <input class="form-check-input" type="radio" name="desired_query" id="obscurityQuery" value="obscurity">
            <label class="form-check-label" for="obscurityQuery">
                Measure how <strong>obscure</strong> my taste is
            </label>
        </div>

        <div class="form-check">
            <input class="form-check-input" type="radio" name="desired_query" id="musicAgeQuery" value="music_age">
            <label class="form-check-label" for="musicAgeQuery">
                Compute my <strong>music age</strong>
            </label>
        </div>
    </div>

    <!-- Friend selector for the compatibility query -->
    <div class="col-12 mt-3">
        <label class="form-label" for="friendSelect">
            If you selected "compatibility", choose a friend:
        </label>
        <select class="form-select" id="friendSelect" name="friend_id">
            {% for friend in friends %}
            <option value="{{ friend.user_id }}">{{ friend.username }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="col-12 mt-3">
        <button type="submit" class="btn btn-success">Run query</button>
    </div>
</form>

<!-- 2. Display query result, specialized by type -->
{% if request.method == 'POST' %}
<hr>
<h4 class="mb-3">Query result</h4>

{% if dashboard_result is string %}
    <!-- "dashboard" query: dashboard_result is filename in static/ -->
    {% if dashboard_result %}
        <img class="img-fluid"
             src="{{ url_for('static', filename=dashboard_result) }}"
             alt="Listening dashboard">
        <p class="mt-2">
            Image file:
            <code>{{ dashboard_result }}</code>
        </p>
    {% else %}
        <p class="text-muted">We couldn't generate a dashboard (maybe no liked tracks).</p>
    {% endif %}

{% elif dashboard_result is mapping %}
    <!-- soulmate or recommended friend (dict with friend_id, username) -->
    {% if dashboard_result and 'friend_id' in dashboard_result and 'username' in dashboard_result %}
        <p>
            User:
            <a href="{{ url_for('main.user_page', user_id=dashboard_result.friend_id) }}">
                {{ dashboard_result.username }}
            </a>
        </p>
    {% elif dashboard_result %}
        <!-- generic dict display -->
        <ul>
        {% for key, value in dashboard_result.items() %}
            <li><strong>{{ key }}:</strong> {{ value }}</li>
        {% endfor %}
        </ul>
    {% else %}
        <p class="text-muted">No result for this query.</p>
    {% endif %}

{% elif dashboard_result is sequence %}
    {% if dashboard_result|length > 0 and dashboard_result[0] is mapping %}
        <!-- generic table for list-of-dicts (artists, genres, discovery playlist, etc.) -->
        <table class="table table-dark table-striped table-sm align-middle">
            <thead>
            <tr>
                {% for key in dashboard_result[0].keys() %}
                <th>{{ key }}</th>
                {% endfor %}
            </tr>
            </thead>
            <tbody>
            {% for row in dashboard_result %}
            <tr>
                {% for key, value in row.items() %}
                    {% if key == 'track_id' %}
                        <!-- keep track_id hidden as plain text -->
                        <td>{{ value }}</td>
                    {% elif key == 'title' and 'track_id' in row %}
                        <!-- link titles to track pages when track_id present -->
                        <td>
                            <a class="text-light" href="{{ url_for('main.track_page', track_id=row.track_id) }}">
                                {{ value }}
                            </a>
                        </td>
                    {% else %}
                        <td>{{ value }}</td>
                    {% endif %}
                {% endfor %}
            </tr>
            {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p class="text-muted">No results for this query.</p>
    {% endif %}

{% else %}
    <!-- numbers: compatibility, obscurity, music_age -->
    <p><strong>{{ dashboard_result }}</strong></p>
{% endif %}
{% endif %}

<hr>

<!-- 3. Liked songs table -->
<div class="row mt-4">
    <div class="col-md-6">
        <h4>Your liked songs</h4>
        {% if liked_songs %}
        <table class="table table-dark table-striped table-sm align-middle">
            <thead>
            <tr>
                <th>Title</th>
                <th>Duration (ms)</th>
                <th>Release date</th>
            </tr>
            </thead>
            <tbody>
            {% for song in liked_songs %}
            <tr>
                <td>
                    <a class="text-light" href="{{ url_for('main.track_page', track_id=song.track_id) }}">
                        {{ song.title }}
                    </a>
                </td>
                <td>{{ song.duration_ms }}</td>
                <td>{{ song.release_date }}</td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="text-muted">You don't have any liked songs yet.</p>
        {% endif %}
    </div>

    <!-- 4. Friends list -->
    <div class="col-md-6">
        <h4>Your friends</h4>
        {% if friends %}
        <table class="table table-dark table-striped table-sm align-middle">
            <thead>
            <tr>
                <th>Friend</th>
                <th>Date befriended</th>
            </tr>
            </thead>
            <tbody>
            {% for friend in friends %}
            <tr>
                <td>
                    <a class="text-light" href="{{ url_for('main.user_page', user_id=friend.user_id) }}">
                        {{ friend.username }}
                    </a>
                </td>
                <td>{{ friend.date_befriended }}</td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="text-muted">You don't have any friends yet.</p>
        {% endif %}
    </div>
</div>

{% endblock %}